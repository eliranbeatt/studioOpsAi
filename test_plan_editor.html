<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Editor Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .rtl { direction: rtl; text-align: right; }
    </style>
</head>
<body class="bg-gray-100 rtl">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const PlanEditor = ({ plan, onPlanChange, onSave, isLoading = false }) => {
            const [localPlan, setLocalPlan] = useState(plan);
            const [editingCell, setEditingCell] = useState(null);
            const [editValue, setEditValue] = useState('');

            useEffect(() => {
                setLocalPlan(plan);
            }, [plan]);

            const handleCellClick = (rowIndex, field, value) => {
                setEditingCell({ rowIndex, field });
                setEditValue(String(value));
            };

            const handleCellBlur = () => {
                if (editingCell && editValue !== '') {
                    const { rowIndex, field } = editingCell;
                    const updatedItems = [...localPlan.items];
                    
                    if (field === 'quantity' || field === 'unit_price') {
                        const numericValue = parseFloat(editValue);
                        if (!isNaN(numericValue)) {
                            updatedItems[rowIndex] = {
                                ...updatedItems[rowIndex],
                                [field]: numericValue,
                                subtotal: field === 'quantity' 
                                    ? numericValue * updatedItems[rowIndex].unit_price
                                    : updatedItems[rowIndex].quantity * numericValue
                            };
                        }
                    } else {
                        updatedItems[rowIndex] = {
                            ...updatedItems[rowIndex],
                            [field]: editValue
                        };
                    }

                    const updatedPlan = {
                        ...localPlan,
                        items: updatedItems,
                        total: updatedItems.reduce((sum, item) => sum + item.subtotal, 0)
                    };

                    setLocalPlan(updatedPlan);
                    onPlanChange(updatedPlan);
                }
                
                setEditingCell(null);
                setEditValue('');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleCellBlur();
                } else if (e.key === 'Escape') {
                    setEditingCell(null);
                    setEditValue('');
                }
            };

            const addNewRow = () => {
                const newItem = {
                    category: 'materials',
                    title: 'New Item',
                    quantity: 1,
                    unit: 'unit',
                    unit_price: 0,
                    subtotal: 0
                };

                const updatedPlan = {
                    ...localPlan,
                    items: [...localPlan.items, newItem]
                };

                setLocalPlan(updatedPlan);
                onPlanChange(updatedPlan);
            };

            const deleteRow = (index) => {
                const updatedItems = localPlan.items.filter((_, i) => i !== index);
                const updatedPlan = {
                    ...localPlan,
                    items: updatedItems,
                    total: updatedItems.reduce((sum, item) => sum + item.subtotal, 0)
                };

                setLocalPlan(updatedPlan);
                onPlanChange(updatedPlan);
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('he-IL', {
                    style: 'currency',
                    currency: localPlan.currency || 'NIS'
                }).format(amount);
            };

            return React.createElement('div', { className: 'bg-white rounded-lg shadow' },
                React.createElement('div', { className: 'px-6 py-4 border-b' },
                    React.createElement('h3', { className: 'text-lg font-semibold text-gray-900' }, 
                        `עורך תוכנית - ${localPlan.project_name}`
                    ),
                    React.createElement('p', { className: 'text-sm text-gray-600' },
                        `סך הכל: ${formatCurrency(localPlan.total)} | ${localPlan.items.length} פריטים`
                    )
                ),

                React.createElement('div', { className: 'overflow-x-auto' },
                    React.createElement('table', { className: 'w-full' },
                        React.createElement('thead', null,
                            React.createElement('tr', { className: 'bg-gray-50' },
                                ['קטגוריה', 'תיאור', 'כמות', 'יחידה', 'מחיר ליחידה', 'סה"כ', 'פעולות'].map(header => 
                                    React.createElement('th', { 
                                        key: header, 
                                        className: 'px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase'
                                    }, header)
                                )
                            )
                        ),
                        React.createElement('tbody', { className: 'divide-y divide-gray-200' },
                            localPlan.items.map((item, index) => 
                                React.createElement('tr', { key: index, className: 'hover:bg-gray-50' },
                                    // Category
                                    React.createElement('td', { className: 'px-4 py-2' },
                                        editingCell?.rowIndex === index && editingCell.field === 'category' ?
                                            React.createElement('select', {
                                                value: editValue,
                                                onChange: (e) => setEditValue(e.target.value),
                                                onBlur: handleCellBlur,
                                                onKeyPress: handleKeyPress,
                                                className: 'w-full px-2 py-1 border border-gray-300 rounded text-left',
                                                autoFocus: true
                                            },
                                                React.createElement('option', { value: 'materials' }, 'חומרים'),
                                                React.createElement('option', { value: 'labor' }, 'עבודה'),
                                                React.createElement('option', { value: 'tools' }, 'כלים'),
                                                React.createElement('option', { value: 'logistics' }, 'לוגיסטיקה')
                                            ) :
                                            React.createElement('div', {
                                                className: 'cursor-pointer px-2 py-1 rounded hover:bg-gray-100',
                                                onClick: () => handleCellClick(index, 'category', item.category)
                                            },
                                                item.category === 'materials' && 'חומרים',
                                                item.category === 'labor' && 'עבודה',
                                                item.category === 'tools' && 'כלים',
                                                item.category === 'logistics' && 'לוגיסטיקה'
                                            )
                                    ),

                                    // Title/Description
                                    React.createElement('td', { className: 'px-4 py-2' },
                                        editingCell?.rowIndex === index && editingCell.field === 'title' ?
                                            React.createElement('input', {
                                                type: 'text',
                                                value: editValue,
                                                onChange: (e) => setEditValue(e.target.value),
                                                onBlur: handleCellBlur,
                                                onKeyPress: handleKeyPress,
                                                className: 'w-full px-2 py-1 border border-gray-300 rounded text-right',
                                                autoFocus: true
                                            }) :
                                            React.createElement('div', {
                                                className: 'cursor-pointer px-2 py-1 rounded hover:bg-gray-100 text-right',
                                                onClick: () => handleCellClick(index, 'title', item.title)
                                            },
                                                item.title,
                                                item.description && React.createElement('div', { 
                                                    className: 'text-xs text-gray-500 mt-1' 
                                                }, item.description)
                                            )
                                    ),

                                    // Quantity
                                    React.createElement('td', { className: 'px-4 py-2 text-right' },
                                        editingCell?.rowIndex === index && editingCell.field === 'quantity' ?
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.1',
                                                value: editValue,
                                                onChange: (e) => setEditValue(e.target.value),
                                                onBlur: handleCellBlur,
                                                onKeyPress: handleKeyPress,
                                                className: 'w-20 px-2 py-1 border border-gray-300 rounded text-right',
                                                autoFocus: true
                                            }) :
                                            React.createElement('div', {
                                                className: 'cursor-pointer px-2 py-1 rounded hover:bg-gray-100',
                                                onClick: () => handleCellClick(index, 'quantity', item.quantity)
                                            }, item.quantity)
                                    ),

                                    // Unit
                                    React.createElement('td', { className: 'px-4 py-2 text-right' },
                                        editingCell?.rowIndex === index && editingCell.field === 'unit' ?
                                            React.createElement('input', {
                                                type: 'text',
                                                value: editValue,
                                                onChange: (e) => setEditValue(e.target.value),
                                                onBlur: handleCellBlur,
                                                onKeyPress: handleKeyPress,
                                                className: 'w-20 px-2 py-1 border border-gray-300 rounded text-right',
                                                autoFocus: true
                                            }) :
                                            React.createElement('div', {
                                                className: 'cursor-pointer px-2 py-1 rounded hover:bg-gray-100',
                                                onClick: () => handleCellClick(index, 'unit', item.unit)
                                            }, item.unit)
                                    ),

                                    // Unit Price
                                    React.createElement('td', { className: 'px-4 py-2 text-right' },
                                        editingCell?.rowIndex === index && editingCell.field === 'unit_price' ?
                                            React.createElement('input', {
                                                type: 'number',
                                                step: '0.01',
                                                value: editValue,
                                                onChange: (e) => setEditValue(e.target.value),
                                                onBlur: handleCellBlur,
                                                onKeyPress: handleKeyPress,
                                                className: 'w-24 px-2 py-1 border border-gray-300 rounded text-right',
                                                autoFocus: true
                                            }) :
                                            React.createElement('div', {
                                                className: 'cursor-pointer px-2 py-1 rounded hover:bg-gray-100',
                                                onClick: () => handleCellClick(index, 'unit_price', item.unit_price)
                                            }, formatCurrency(item.unit_price))
                                    ),

                                    // Subtotal
                                    React.createElement('td', { 
                                        className: 'px-4 py-2 text-right font-medium'
                                    }, formatCurrency(item.subtotal)),

                                    // Actions
                                    React.createElement('td', { className: 'px-4 py-2 text-center' },
                                        React.createElement('button', {
                                            onClick: () => deleteRow(index),
                                            className: 'text-red-600 hover:text-red-800 text-sm'
                                        }, 'מחק')
                                    )
                                )
                            )
                        ),
                        React.createElement('tfoot', { className: 'bg-gray-50' },
                            React.createElement('tr', null,
                                React.createElement('td', { 
                                    colSpan: 5, 
                                    className: 'px-4 py-3 text-right font-medium'
                                }, 'סה"כ פרויקט:'),
                                React.createElement('td', { 
                                    className: 'px-4 py-3 text-right font-bold text-lg'
                                }, formatCurrency(localPlan.total)),
                                React.createElement('td', null)
                            )
                        )
                    )
                ),

                React.createElement('div', { className: 'px-6 py-4 border-t' },
                    React.createElement('div', { className: 'flex justify-between items-center' },
                        React.createElement('button', {
                            onClick: addNewRow,
                            className: 'px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700'
                        }, '+ הוסף שורה'),
                        
                        onSave && React.createElement('button', {
                            onClick: onSave,
                            disabled: isLoading,
                            className: 'px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50'
                        }, isLoading ? 'שומר...' : 'שמור תוכנית')
                    )
                )
            );
        };

        const TestApp = () => {
            const [plan, setPlan] = useState({
                project_id: 'test-123',
                project_name: 'Test Cabinet Project',
                items: [
                    {
                        category: 'materials',
                        title: 'Plywood 4x8',
                        description: 'Plywood sheet from Hardware Store',
                        quantity: 8,
                        unit: 'sheet',
                        unit_price: 45.99,
                        subtotal: 367.92
                    },
                    {
                        category: 'labor',
                        title: 'Carpenter work',
                        description: 'Carpenter services for cabinet installation',
                        quantity: 16,
                        unit: 'hour',
                        unit_price: 120,
                        subtotal: 1920
                    }
                ],
                total: 2287.92,
                margin_target: 0.25,
                currency: 'NIS'
            });

            const handlePlanChange = (updatedPlan) => {
                setPlan(updatedPlan);
                console.log('Plan updated:', updatedPlan);
            };

            const handleSave = () => {
                alert('Plan saved successfully!');
            };

            return React.createElement('div', { className: 'p-8 bg-gray-100 min-h-screen' },
                React.createElement('div', { className: 'max-w-6xl mx-auto' },
                    React.createElement('h1', { className: 'text-3xl font-bold text-center mb-8' }, 'Plan Editor Demo'),
                    React.createElement(PlanEditor, {
                        plan: plan,
                        onPlanChange: handlePlanChange,
                        onSave: handleSave
                    })
                )
            );
        };

        ReactDOM.render(React.createElement(TestApp), document.getElementById('root'));
    </script>
</body>
</html>